/*
 * Copyright(c) 2016,南京长盛仪器
 * All rights reserved
 * 文件名称：cs99xx_ir_shift_gear.c
 * 摘  要  ：主程序
 * 当前版本：V1.0，编写者：王鑫
 * 历史版本：
 * 修改记录：
 *
 */

#include "stm32f10x.h"
#include "cs99xx_ir_shift_gear.h"
#include "serve_test.h"
#include "cs99xx_type.h"


static const float ir_10M_shift_point_5kV[][4]=
/* 1 10M */
{
    {0, 0.008, 0.006, 0.005}, //100v
    {0, 0.125, 0.045, 0.020}, //200v
    {0, 0.125, 0.045, 0.020}, //300v
    {0, 0.125, 0.085, 0.050}, //400v
    
    {0, 0.125, 0.085, 0.050}, //500v
    
    {0, 0.125, 0.085, 0.050}, //600v
    {0, 0.200, 0.150, 0.050}, //700v
    {0, 0.200, 0.150, 0.050}, //800v
    {0, 0.200, 0.150, 0.050}, //900v
    
    {0, 0.200, 0.170, 0.050}, //1000v
    
    {0, 0.200, 0.170, 0.050}, //1100v
    {0, 0.270, 0.200, 0.090}, //1200v
    
    {0, 0.400, 0.250, 0.150}, //1300v
    {0, 0.440, 0.280, 0.150}, //1400v
    {0, 0.440, 0.300, 0.150}, //1500v
    
    {0, 0.440, 0.350, 0.150}, //2000v
    {0, 0.440, 0.350, 0.190}, //2500v
    {0, 0.440, 0.350, 0.250}, //3000v
    {0, 0.440, 0.350, 0.270}, //3500v
    {0, 0.440, 0.350, 0.270}, //4000v
    {0, 0.440, 0.350, 0.270}, //4500v
    {0, 0.440, 0.350, 0.270}, //5000v
};
/* 2 100M */
static const float ir_100M_shift_point_5kV[][4]=
{
    {0.110, 0.030, 0.017, 0.010}, //100v
    {0.250, 0.065, 0.037, 0.020}, //200v
    {0.250, 0.095, 0.060, 0.020}, //300v
    {0.550, 0.125, 0.077, 0.050}, //400v
    
    {0.550, 0.125, 0.085, 0.040}, //500v
    
    {0.550, 0.185, 0.100, 0.040}, //600v
    {0.550, 0.185, 0.120, 0.080}, //700v
    {0.550, 0.250, 0.150, 0.080}, //800v
    {0.550, 0.250, 0.150, 0.080}, //900v
    
    {0.550, 0.350, 0.190, 0.080}, //1000v
    
    {0.550, 0.350, 0.190, 0.080}, //1100v
    
    {0.950, 0.350, 0.250, 0.090}, //1200v
    {1.550, 0.400, 0.250, 0.150}, //1300v
    {1.550, 0.440, 0.280, 0.150}, //1400v
    {1.550, 0.450, 0.300, 0.150}, //1500v
    
    {1.550, 0.675, 0.400, 0.150}, //2000v
    {1.950, 0.832, 0.500, 0.190}, //2500v
    {2.550, 0.932, 0.600, 0.250}, //3000v
    {2.750, 1.150, 0.700, 0.270}, //3500v
    {2.750, 1.320, 0.800, 0.270}, //4000v
    {2.750, 1.500, 0.900, 0.270}, //4500v
    {2.750, 1.650, 0.980, 0.270}, //5000v
};
/* 3 1000M */
static const float ir_1000M_shift_point_5kV[][4]=
{
    {0.110, 0.030, 0.017, 0.010}, //100v
    {0.250, 0.065, 0.037, 0.025}, //200v
    {0.250, 0.095, 0.060, 0.025}, //300v
    {0.450, 0.125, 0.077, 0.050}, //400v
    
    {0.450, 0.125, 0.085, 0.050}, //500v
    
    {0.450, 0.125, 0.085, 0.050}, //600v
    
    {0.850, 0.200, 0.150, 0.050}, //700v
    {0.850, 0.250, 0.150, 0.060}, //800v
    {0.850, 0.250, 0.150, 0.060}, //900v
    {0.850, 0.250, 0.190, 0.060}, //1000v
    {0.850, 0.350, 0.220, 0.080}, //1100v
    
    {0.950, 0.400, 0.250, 0.090}, //1200v
    {1.550, 0.400, 0.250, 0.150}, //1300v
    {1.550, 0.440, 0.280, 0.150}, //1400v
    {1.550, 0.440, 0.300, 0.150}, //1500v
    
    {1.550, 0.675, 0.400, 0.150}, //2000v
    {1.950, 0.832, 0.500, 0.190}, //2500v
    {2.550, 0.932, 0.600, 0.250}, //3000v
    {2.750, 1.150, 0.700, 0.270}, //3500v
    {2.750, 1.320, 0.800, 0.270}, //4000v
    {2.750, 1.500, 0.900, 0.270}, //4500v
    {2.750, 1.650, 0.980, 0.270}, //5000v
};
/* 4 10G */
static const float ir_10G_shift_point_5kV[][4]=
{
    {0.110, 0.030, 0.017, 0.000}, //100v
    {0.250, 0.065, 0.037, 0.000}, //200v
    {0.250, 0.095, 0.060, 0.000}, //300v
    {0.550, 0.125, 0.077, 0.040}, //400v
    
    {0.550, 0.125, 0.085, 0.040}, //500v
    
    {0.550, 0.125, 0.110, 0.040}, //600v
    {0.550, 0.200, 0.145, 0.070}, //700v
    {0.650, 0.250, 0.145, 0.070}, //800v
    {0.650, 0.250, 0.145, 0.070}, //900v
    {0.650, 0.250, 0.165, 0.070}, //1000v
    
    {0.850, 0.350, 0.200, 0.090}, //1100v
    
    {0.950, 0.350, 0.200, 0.090}, //1200v
    {1.550, 0.500, 0.250, 0.150}, //1300v
    {1.550, 0.500, 0.280, 0.150}, //1400v
    {1.550, 0.500, 0.300, 0.150}, //1500v
    
    {1.550, 0.675, 0.400, 0.150}, //2000v
    {1.950, 0.832, 0.500, 0.190}, //2500v
    {2.550, 0.932, 0.600, 0.250}, //3000v
    {2.750, 1.150, 0.700, 0.270}, //3500v
    {2.750, 1.320, 0.800, 0.270}, //4000v
    {2.750, 1.500, 0.900, 0.270}, //4500v
    {2.750, 1.650, 0.980, 0.270}, //5000v
};
/* 5 100G */
static const float ir_100G_shift_point_5kV[][5]=
{
    {0.450, 0.125, 0.100, 0.075, 0.040}, //100v
    {0.450, 0.125, 0.100, 0.075, 0.040}, //200v
    {0.200, 0.125, 0.100, 0.075, 0.040}, //300v
    {0.450, 0.125, 0.100, 0.075, 0.040}, //400v
    
    {0.450, 0.160, 0.095, 0.065, 0.040}, //500v
    
    {0.450, 0.160, 0.095, 0.075, 0.040}, //600v
    {0.750, 0.200, 0.150, 0.100, 0.040}, //700v
    {0.750, 0.250, 0.150, 0.100, 0.040}, //800v
    {0.750, 0.250, 0.180, 0.120, 0.040}, //900v
    
    {0.750, 0.280, 0.180, 0.140, 0.040}, //1000v
    
    {0.950, 0.350, 0.220, 0.175, 0.040}, //1100v
    {0.950, 0.350, 0.230, 0.175, 0.040}, //1200v
    {1.550, 0.400, 0.330, 0.220, 0.150}, //1300v
    {1.550, 0.400, 0.330, 0.220, 0.150}, //1400v
    {1.550, 0.450, 0.330, 0.220, 0.150}, //1500v
    
    {1.550, 0.600, 0.430, 0.320, 0.150}, //2000v
    {1.950, 0.800, 0.545, 0.465, 0.150}, //2500v
    {2.550, 0.900, 0.645, 0.565, 0.150}, //3000v
    {2.750, 1.130, 0.780, 0.565, 0.150}, //3500v
    {2.750, 1.320, 0.880, 0.665, 0.150}, //4000v
    {2.750, 1.500, 1.000, 0.865, 0.150}, //4500v
    {2.750, 1.650, 1.000, 0.965, 0.150}, //5000v
};
/* 1 10M */
static const float ir_10M_shift_point_1_5kV[][4]=
{
    {0, 0.075, 0.065, 0.050}, //100v
    {0, 0.175, 0.125, 0.110}, //200v
    {0, 0.215, 0.135, 0.065}, //300v
    {0, 0.225, 0.155, 0.090}, //400v
    
    {0, 0.325, 0.125, 0.100}, //500v
    
    {0, 1.250, 0.200, 0.115}, //600v
    {0, 1.550, 0.230, 0.150}, //700v
    {0, 1.550, 0.260, 0.170}, //800v
    {0, 1.550, 0.260, 0.200}, //900v
    
    {0, 1.550, 0.260, 0.230}, //1000v
    
    {0, 1.550, 0.260, 0.250}, //1100v
    {0, 1.550, 0.260, 0.280}, //1200v
    
    {0, 1.550, 0.260, 0.280}, //1300v
    {0, 1.550, 0.260, 0.310}, //1400v
    {0, 1.550, 0.500, 0.310}, //1500v
};
/* 2 100M 1000M */
static const float ir_100M_shift_point_1_5kV[][4]=
{
    {0.530, 0.150, 0.065, 0.050}, //100v
    {1.150, 0.260, 0.120, 0.050}, //200v
    {0.700, 0.250, 0.135, 0.065}, //300v
    {0.950, 0.350, 0.150, 0.090}, //400v
    
    {1.100, 0.325, 0.125, 0.105}, //500v
    
    {1.200, 0.550, 0.225, 0.115}, //600v
    {1.550, 0.750, 0.300, 0.150}, //700v
    {1.750, 0.750, 0.340, 0.170}, //800v
    {2.050, 0.750, 0.340, 0.200}, //900v
    
    {2.350, 0.750, 0.450, 0.230}, //1000v
    
    {2.550, 0.750, 0.450, 0.250}, //1100v
    
    {2.850, 0.750, 0.450, 0.280}, //1200v
    {2.850, 0.750, 0.450, 0.280}, //1300v
    {3.150, 0.750, 0.450, 0.310}, //1400v
    {3.150, 0.750, 0.500, 0.310}, //1500v
};
/* 4 10G 量程100G */
static const float ir_10G_shift_point_1_5kV[][4]=
{
    {0.550, 0.150, 0.040, 0.000}, //100v
    {0.550, 0.260, 0.120, 0.000}, //200v
    {0.700, 0.150, 0.085, 0.000}, //300v
    {0.950, 0.150, 0.085, 0.000}, //400v
    
    {1.100, 0.225, 0.125, 0.100}, //500v
    
    {1.200, 0.550, 0.225, 0.115}, //600v
    {1.550, 0.750, 0.300, 0.150}, //700v
    {1.750, 0.750, 0.300, 0.170}, //800v
    {2.050, 0.750, 0.300, 0.200}, //900v
    
    {2.350, 0.750, 0.450, 0.230}, //1000v
    
    {2.550, 0.750, 0.450, 0.250}, //1100v
    
    {2.850, 0.750, 0.450, 0.280}, //1200v
    {2.850, 0.750, 0.450, 0.280}, //1300v
    {3.150, 0.750, 0.450, 0.310}, //1400v
    {3.150, 0.750, 0.500, 0.310}, //1500v
};
/* 5 100G */
static const float ir_100G_shift_point_1_5kV[][5]=
{
    {0.550, 0.125, 0.100, 0.075, 0.000}, //100v
    {0.550, 0.125, 0.100, 0.075, 0.000}, //200v
    {0.700, 0.125, 0.100, 0.075, 0.000}, //300v
    {1.000, 0.125, 0.100, 0.075, 0.000}, //400v
    
    {1.150, 0.530, 0.185, 0.000, 0.000}, //500v
    
    {1.200, 0.530, 0.230, 0.085, 0.000}, //600v
    {1.550, 0.750, 0.285, 0.150, 0.000}, //700v
    {1.750, 0.750, 0.285, 0.160, 0.000}, //800v
    {2.050, 0.750, 0.290, 0.180, 0.000}, //900v
    
    {2.350, 0.750, 0.290, 0.185, 0.000}, //1000v
    
    {2.550, 1.200, 0.450, 0.220, 0.000}, //1100v
    {2.850, 1.200, 0.450, 0.220, 0.000}, //1200v
    {2.850, 1.200, 0.450, 0.220, 0.000}, //1300v
    {3.150, 1.200, 0.450, 0.290, 0.000}, //1400v
    {3.150, 1.200, 0.450, 0.200, 0.000}, //1500v
};
/* 4 10G 量程10G */
static const float ir_10G_shift_point_1_5kV_10G[][5]=
{
    {0.550, 0.130, 0.055, 0.018, 0.000}, //100v
    {0.550, 0.250, 0.079, 0.039, 0.000}, //200v
    {0.700, 0.330, 0.122, 0.062, 0.000}, //300v
    {0.950, 0.430, 0.166, 0.084, 0.000}, //400v
    
    {1.150, 0.530, 0.209, 0.108, 0.000}, //500v
    
    {1.200, 0.530, 0.251, 0.130, 0.000}, //600v
    {1.550, 0.750, 0.294, 0.153, 0.000}, //700v
    {1.750, 0.750, 0.337, 0.176, 0.000}, //800v
    {2.050, 0.750, 0.379, 0.198, 0.000}, //900v
    
    {2.350, 0.750, 0.423, 0.220, 0.000}, //1000v
    
    {2.550, 1.200, 0.450, 0.220, 0.000}, //1100v
    {2.850, 1.200, 0.450, 0.220, 0.000}, //1200v
    {2.850, 1.200, 0.450, 0.220, 0.000}, //1300v
    {3.150, 1.200, 0.450, 0.290, 0.000}, //1400v
    {3.150, 1.200, 0.450, 0.290, 0.000}, //1500v
};
/*********************************************************/
static const float ir_10M_shift_point_1kV[][2]=
/* 1 10M */
{
    {0, 0.100}, //100v
    {0, 0.100}, //200v
    {0, 0.100}, //300v
    {0, 0.100}, //400v
    {0, 0.100}, //500v
    {0, 0.100}, //600v
    {0, 0.100}, //700v
    {0, 0.100}, //800v
    {0, 0.100}, //900v
    {0, 0.100}, //1000v
};
/* 2 100M 1000M */
static const float ir_100M_shift_point_1kV[][2]=
{
    {1.050, 0.100}, //100v
    {1.050, 0.100}, //200v
    {1.050, 0.100}, //300v
    {1.050, 0.100}, //400v
    {1.050, 0.100}, //500v
    {1.050, 0.100}, //600v
    {1.050, 0.100}, //700v
    {1.050, 0.100}, //800v
    {1.050, 0.100}, //900v
    {1.050, 0.100}, //1000v
};
/* 4 10G */
static const float ir_10G_shift_point_1kV[][3]=
{
    {0.220, 0.150, 0.040}, //100v
    {0.450, 0.150, 0.085}, //200v
    {0.700, 0.150, 0.085}, //300v
    {1.050, 0.300, 0.100}, //400v
    {1.050, 0.300, 0.100}, //500v
    {1.050, 0.300, 0.100}, //600v
    {1.050, 0.300, 0.100}, //700v
    {1.050, 0.300, 0.100}, //800v
    {1.050, 0.300, 0.100}, //900v
    {1.050, 0.300, 0.100}, //1000v
};
/* 5 100G */
static const float ir_100G_shift_point_1kV[][3]=
{
    {0.450, 0.075, 0.000}, //100v
    {0.450, 0.075, 0.000}, //200v
    {0.200, 0.075, 0.000}, //300v
    {0.450, 0.075, 0.000}, //400v
    {1.050, 0.300, 0.000}, //500v
    {1.050, 0.300, 0.000}, //600v
    {1.050, 0.300, 0.000}, //700v
    {1.050, 0.300, 0.000}, //800v
    {1.050, 0.300, 0.000}, //900v
    {1.050, 0.300, 0.000}, //1000v
};
/*************************************************/

/* 3 100M 1000M */
static const float ir_100M_shift_point_10kV[][4]=
{
    {3.5, 1.100, 0.300, 0.185}, //5000v
    {3.5, 1.200, 0.700, 0.235}, //5500v
    {3.5, 1.380, 0.800, 0.235}, //6000v
    {3.5, 1.500, 0.900, 0.275}, //6500v
    {3.5, 1.600, 1.000, 0.295}, //7000v
    {3.5, 1.700, 1.200, 0.295}, //7500v
    {3.5, 1.800, 1.300, 0.295}, //8000v
    {3.5, 1.900, 1.400, 0.315}, //8500v
    {3.5, 2.000, 1.500, 0.315}, //9000v
    {3.5, 2.100, 1.600, 0.320}, //9500v
};
/* 4 10G */
static const float ir_10G_shift_point_10kV[][4]=
{
    {1.900, 1.100, 0.850, 0.185}, //5000v
    {2.400, 1.100, 0.700, 0.235}, //5500v
    {2.400, 1.380, 0.800, 0.235}, //6000v
    {2.800, 1.500, 0.900, 0.275}, //6500v
    {3.000, 1.600, 1.000, 0.295}, //7000v
    {3.000, 1.700, 1.100, 0.295}, //7500v
    {3.000, 1.800, 1.200, 0.295}, //8000v
    {3.200, 1.900, 1.300, 0.315}, //8500v
    {3.200, 2.000, 1.400, 0.315}, //9000v
    {3.250, 2.100, 1.000, 0.320}, //9500v
};
/* 5 100G */
static const float ir_100G_shift_point_10kV[][4]=
{
    {1.900, 1.100, 0.850, 0.100}, //5000v
    {2.400, 1.100, 0.950, 0.100}, //5500v
    {2.400, 1.380, 1.050, 0.100}, //6000v
    {2.800, 1.500, 1.150, 0.100}, //6500v
    {3.000, 1.600, 1.200, 0.100}, //7000v
    {3.000, 1.700, 1.250, 0.100}, //7500v
    {3.000, 1.800, 1.300, 0.100}, //8000v
    {3.200, 1.900, 1.400, 0.100}, //8500v
    {3.200, 2.000, 1.500, 0.100}, //9000v
    {3.250, 2.100, 1.000, 0.100}, //9500v
};

/*************************************************/

typedef struct {
    const float * points;/* 指向换挡点数组 将二维数组通过一维数组来访问 */
    const uint8_t segments;/* 硬件档位被换挡点分的段数3点分两段 */
    const uint8_t vol_num;/* 电压档个数 */
    const uint8_t base;/* 当前软件档位基数值 当前档位前面segments 软件档位的累加和 */
}IR_SHIFT_GEAR_INFO;

static const IR_SHIFT_GEAR_INFO ir_shift_gear_info_5kV[5]=
{
    {(void*)ir_10M_shift_point_5kV      , 3, 22, 0},
    {(void*)ir_100M_shift_point_5kV     , 3, 22, 0 + 3},
    {(void*)ir_1000M_shift_point_5kV    , 3, 22, 0 + 3 + 3},
    {(void*)ir_10G_shift_point_5kV      , 3, 22, 0 + 3 + 3 + 3},
    {(void*)ir_100G_shift_point_5kV     , 4, 22, 0 + 3 + 3 + 3 + 3},
};

static const IR_SHIFT_GEAR_INFO ir_shift_gear_info_1_5kV[5]=
{
    {(void*)ir_10M_shift_point_1_5kV      , 3, 15, 0},
    {(void*)ir_100M_shift_point_1_5kV     , 3, 15, 0 + 3},
    {(void*)ir_100M_shift_point_1_5kV     , 3, 15, 0 + 3 + 3},
    {(void*)ir_10G_shift_point_1_5kV      , 3, 15, 0 + 3 + 3 + 3},
    {(void*)ir_100G_shift_point_1_5kV     , 4, 15, 0 + 3 + 3 + 3 + 3},
};
static const IR_SHIFT_GEAR_INFO ir_shift_gear_info_1_5kV_10G[4]=
{
    {(void*)ir_10M_shift_point_1_5kV      , 3, 15, 0},
    {(void*)ir_100M_shift_point_1_5kV     , 3, 15, 0 + 3},
    {(void*)ir_100M_shift_point_1_5kV     , 3, 15, 0 + 3 + 3},
    {(void*)ir_10G_shift_point_1_5kV_10G  , 4, 15, 0 + 3 + 3 + 3},
};
static const IR_SHIFT_GEAR_INFO ir_shift_gear_info_1kV[5]=
{
    {(void*)ir_10M_shift_point_1kV      , 1, 10, 0},
    {(void*)ir_100M_shift_point_1kV     , 1, 10, 0 + 1},
    {(void*)ir_100M_shift_point_1kV     , 1, 10, 0 + 1 + 1},
    {(void*)ir_10G_shift_point_1kV      , 2, 10, 0 + 1 + 1 + 1},
    {(void*)ir_100G_shift_point_1kV     , 2, 10, 0 + 1 + 1 + 1 + 2},
};

static const IR_SHIFT_GEAR_INFO ir_shift_gear_info_10kV[]=
{
    {(void*)ir_100M_shift_point_10kV    , 3, 10, 0},
    {(void*)ir_10G_shift_point_10kV     , 3, 10, 0 + 3},
    {(void*)ir_100G_shift_point_10kV    , 3, 10, 0 + 3 + 3},
};

static const IR_SHIFT_GEAR_INFO *gear_info;

void init_set_ir_gear(void)
{
    uint8_t gear_base = 0;
    
    if(0/*type_spe.ir_vol_range == IR_1kV || type_spe.ir_vol_range == IR_1_5kV*/)
    {
        gear_info = ir_shift_gear_info_1kV;
    }
    else if(type_spe.ir_vol_range == IR_1kV || type_spe.ir_vol_range == IR_1_5kV)
    {
        if(type_spe.ir_res_h <= 10*1000)
        {
            gear_info = ir_shift_gear_info_1_5kV_10G;
        }
        else
        {
            gear_info = ir_shift_gear_info_1_5kV;
        }
    }
    else if(type_spe.ir_vol_range == IR_10kV)
    {
        gear_info = ir_shift_gear_info_10kV;
    }
    else
    {
        gear_info = ir_shift_gear_info_5kV;
    }
    
    cur_soft_gear = 0;
    gear_base = gear_info[cur_gear - cur_gear_min].base;
    ir_set_gear(cur_gear, gear_base + cur_soft_gear);
}
enum{
DECREASE,INCREASE
};
void switch_ir_gear(uint8_t st)
{
	switch(st)
	{
		case INCREASE:
			cur_gear++;
			break;
		case DECREASE:
			cur_gear--;
			break;
	}
	
	clear_slither_data();/* 换挡后要清空滤波缓冲区 */
}
void ir_auto_find_gear(void)
{
    uint8_t LEAD_T  = 20; /* 超前时间 */
    uint8_t temp = 0;
    uint8_t gear_base = 0;
    float test_ad_vol_u;
    float test_ad_vol_d;
	
    
	/* 如果档位保持开关打开 */
    if(g_custom_sys_par.ir_gear_hold == SYS_SW_ON)
	{
        /* g_ir_gear_hold 单位是 ms; dis_time 单位是100ms */
		if(g_test_data.dis_time * 100 < g_ir_gear_hold)
		{
			return;
		}
	}
	
    /* 延时时间还比LEAD_T大就退出 */
    if(g_ir_dly > LEAD_T)
    {
        return;
    }
    
    gear_base = gear_info[cur_gear - cur_gear_min].base;
    temp = gear_info[cur_gear-cur_gear_min].segments + 1;//用于索引数组中的元素
    /* 通过访问一维数组的方法访问所指向的二维数组的元素 */
    test_ad_vol_d = gear_info[cur_gear - cur_gear_min].points[cur_vol_gear * temp + cur_soft_gear];
    test_ad_vol_u = gear_info[cur_gear - cur_gear_min].points[cur_vol_gear * temp + cur_soft_gear + 1];
    temp = gear_info[cur_gear - cur_gear_min].segments - 1;//用于限定当前的软件档位最大值 应为软件档位是从0开始的
    
    /* 向上换档 */
    if(cur_ad_vol == 0 || cur_ad_vol < test_ad_vol_u)
    {
        if(cur_soft_gear < temp)
        {
            cur_soft_gear++;
        }
        else
        {
            if(cur_gear < cur_gear_max)
            {
                if(cur_auto == AUTO_SHIFT_ON)
                {
					switch_ir_gear(INCREASE);
                }
                /* 自动换挡关闭，为了测试电阻的准确运行档位向上增加或减小1 */
                else
                {
                    if(cur_gear < cur_ir_dis_gear_1)
                    {
						switch_ir_gear(INCREASE);
                    }
                }
                
                g_ir_dly += g_ir_gear_hold;
                cur_soft_gear = 0;
                
                /* 在换到10G档后多停留一会儿可以减小
                    10G与100G交界处10G档电阻的稳定时间 */
				if(cur_gear == 4)
				{
//					g_ir_dly += 1000;
				}
            }
        }
        
        gear_base = gear_info[cur_gear - cur_gear_min].base;
        ir_set_gear(cur_gear, gear_base + cur_soft_gear);
    }
    /* 向下换档 */
    else if(cur_ad_vol > test_ad_vol_d)
    {
        if(cur_soft_gear > 0)
        {
            cur_soft_gear--;
        }
        else
        {
            if(cur_gear > cur_gear_min)
            {
				/* 在慢速测试时不 要向下档  */
				if(sys_par.ir_speed_sw != IR_FILTERING_DEEP_SLOW)
				{
					if(cur_auto == AUTO_SHIFT_ON)
					{
						switch_ir_gear(DECREASE);
					}
					/* 自动换挡关闭，为了测试电阻的准确运行档位向上增加或减小1 */
					else
					{
						if(cur_gear > cur_ir_dis_gear_0)
						{
							switch_ir_gear(DECREASE);
						}
					}
				}
                cur_soft_gear = 0;
                g_ir_dly += g_ir_gear_hold;
            }
        }
        
        gear_base = gear_info[cur_gear - cur_gear_min].base;
        ir_set_gear(cur_gear, gear_base + cur_soft_gear);
    }
}


/******************* (C) COPYRIGHT 2015 长盛仪器 *****END OF FILE****/
